<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="google-site-verification" content="xBT4GhYoi5qRD5tr338pgPM5OWHHIDR6mNg1a3euekI" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
    <meta name="description" content="这里是 周海军 的个人博客">
    <meta name="keywords" content="周海军, Fusha, navy, @navy, 周海军的博客, Fusha Blog, 博客, 个人网站, 互联网, 后端, 设计">
    <meta name="theme-color" content="#000000">

    <!-- Open Graph -->
    <meta property="og:title"
        content="一个gdb问题引发的思考 - 孚沙的博客 | Fusha Blog">
    
    <meta property="og:type" content="article">
    <meta property="og:description" content="问题现象
">
    
    <meta property="article:published_time" content=" 2021-04-06T03:00:00Z">
    
    
    <meta property="article:author" content="zhouhaijun">
    
    
    <meta property="article:tag" content="被夹">
    
    
    <meta property="og:image" content="http://localhost:4000">
    <meta property="og:url" content="http://localhost:4000/2021/04/06/thingking-about-gdb/">
    <meta property="og:site_name" content="孚沙的博客 | Fusha Blog">

    <title>一个gdb问题引发的思考 - 孚沙的博客 | Fusha Blog</title>

    <!-- Web App Manifest -->
    <link rel="manifest" href="/pwa/manifest.json">

    <!-- Favicon -->
    <link rel="shortcut icon" href="/img/favicon.ico">

    <!-- Canonical URL -->
    <link rel="canonical" href="http://localhost:4000/2021/04/06/thingking-about-gdb/">

    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href=" /css/bootstrap.min.css">

    <!-- Custom CSS -->
    <link rel="stylesheet" href=" /css/hux-blog.min.css">

    <!-- Custom Fonts -->
    <!-- <link href="http://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet" type="text/css"> -->
    <!-- Hux change font-awesome CDN to qiniu -->
    <link href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet"
        type="text/css">


    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- ga & ba script hoook -->
    <script></script>

    <!-- Google AdSense -->
    <script data-ad-client="ca-pub-6487568398225121" async
        src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
</head>


<!-- hack iOS CSS :active style -->
<body ontouchstart="">

    <!-- Navigation -->

<nav class="navbar navbar-default navbar-custom navbar-fixed-top invert">
    
        <div class="container-fluid">
            <!-- Brand and toggle get grouped for better mobile display -->
            <div class="navbar-header page-scroll">
                <button type="button" class="navbar-toggle">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand" href="/">Fusha Blog</a>
            </div>

            <!-- Collect the nav links, forms, and other content for toggling -->
            <div id="huxblog_navbar">
                <div class="navbar-collapse">
                    <ul class="nav navbar-nav navbar-right">
                        <li>
                            <a href="/">Home</a>
                        </li>
                        
                        
                        
                        
                        <li>
                            <a href="/about/">About</a>
                        </li>
                        
                        
                        
                        <li>
                            <a href="/archive/">Archive</a>
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        <li class="search-icon">
                            <a href="javascript:void(0)">
                                <i class="fa fa-search"></i>
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
            <!-- /.navbar-collapse -->
        </div>
        <!-- /.container -->
    </nav>

    <script>
        // Drop Bootstarp low-performance Navbar
        // Use customize navbar with high-quality material design animation
        // in high-perf jank-free CSS3 implementation
        var $body = document.body;
        var $toggle = document.querySelector('.navbar-toggle');
        var $navbar = document.querySelector('#huxblog_navbar');
        var $collapse = document.querySelector('.navbar-collapse');

        var __HuxNav__ = {
            close: function () {
                $navbar.className = " ";
                // wait until animation end.
                setTimeout(function () {
                    // prevent frequently toggle
                    if ($navbar.className.indexOf('in') < 0) {
                        $collapse.style.height = "0px"
                    }
                }, 400)
            },
            open: function () {
                $collapse.style.height = "auto"
                $navbar.className += " in";
            }
        }

        // Bind Event
        $toggle.addEventListener('click', function (e) {
            if ($navbar.className.indexOf('in') > 0) {
                __HuxNav__.close()
            } else {
                __HuxNav__.open()
            }
        })

        /**
         * Since Fastclick is used to delegate 'touchstart' globally
         * to hack 300ms delay in iOS by performing a fake 'click',
         * Using 'e.stopPropagation' to stop 'touchstart' event from 
         * $toggle/$collapse will break global delegation.
         * 
         * Instead, we use a 'e.target' filter to prevent handler
         * added to document close HuxNav.  
         *
         * Also, we use 'click' instead of 'touchstart' as compromise
         */
        document.addEventListener('click', function (e) {
            if (e.target == $toggle) return;
            if (e.target.className == 'icon-bar') return;
            __HuxNav__.close();
        })
    </script>
    <!-- Search -->
<div class="search-page">
  <div class="search-icon-close-container">
    <span class="search-icon-close">
      <i class="fa fa-chevron-down"></i>
    </span>
  </div>
  <div class="search-main container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <form></form>
        <input type="text" id="search-input" placeholder="$ grep...">
        </form>
        <div id="search-results" class="mini-post-list"></div>
      </div>
    </div>
  </div>
</div>

    <!-- Image to hack wechat -->
<!-- <img src="/img/icon_wechat.png" width="0" height="0"> -->
<!-- <img src="/img/home-bg.jpg" width="0" height="0"> -->

<!-- Post Header -->



<style type="text/css">
    header.intro-header{
        position: relative;
        background-image: url('/img/home-bg.jpg');
        background: ;
    }

    
</style>

<header class="intro-header style-text" >

    <div class="header-mask"></div>
    
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-heading">
                    <div class="tags">
                        
                        <a class="tag" href="/archive/?tag=%E8%A2%AB%E5%A4%B9" title="被夹">被夹</a>
                        
                    </div>
                    <h1>一个gdb问题引发的思考</h1>
                    
                    <h2 class="subheading">thinking about gdb</h2>
                    <span class="meta">Posted by zhouhaijun on April 6, 2021</span>
                </div>
            </div>
        </div>
    </div>
</header>






<!-- Post Content -->
<article>
    <div class="container">
        <div class="row">

    <!-- Post Container -->
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                post-container">

                <!-- Multi-Lingual -->
                

				<h3 id="问题现象">问题现象</h3>

<p>今天在用gdb调试代码的过程中，遇到一个有意思的问题。</p>

<p>问题是这样的，当我在docker镜像里，使用gdb去attach一个进程，在布置完断点后执行调试程序时，gdb抛出了一个错误：</p>

<blockquote>
  <p>“Cannot get thread event message: debugger service failed”</p>
</blockquote>

<p>这里说明一下，我使用的gdb的版本为7.6.1，操作系统是centos 7.9。</p>

<h3 id="查资料">查资料</h3>

<p>用谷歌在网上查了一下，找到一篇有价值的资料(完整的资料链接我放在文末)</p>

<blockquote>
  <p>I fought with similar gdb issues for a while. My case was having lots of threads spawned that executed few functions and then exited.</p>

  <p>It appears if a thread exits too fast and there’s lots of these happening sometimes gdb cannot keep up and when it fails, it fails with style as in crashes :) I think it tries to attach to a thread that is already done as per the error message.</p>

  <p>I see this as an issue in gdb 6.5 to 7.6 and still happening. Did not try with older versions.</p>

  <p>My advice is look for this use case or similar. Once I changed my design to have a thread serving a queue of requests gdb works flawlessly.</p>

  <p>Design wise is healthier to have already created threads that digest actions than always spawning new threads.</p>

  <p>Still same code debugs without a problem on Visual Studio so I do have to say that is a small disappointment to me with regards to gdb.</p>

  <p>I use Eclipse and looking at the GDB traces (usually enabled by default) will give you a better hint of where GDB fails. One of the buttons on the console shows you the GDB trace.</p>
</blockquote>

<p>简单解释一下，在程序中创建线程：线程里只是执行几个函数就退出，当在程序中大量的创建这样的线程，导致的一种情况就是gdb的尝试捕获线程信息时出错，表现出来的现象就跟程序崩溃一样，作者在gdb 6.5和7.6的版本上都发现了类似问题。</p>

<h3 id="阅读源码">阅读源码</h3>

<p>上述是从网上摘的一个资料，我其实也是比较好奇gdb内部到底做了什么，这个错误背后的原因具体是什么？于是我从网上找来了gdb 7.6.1的源码，针对上面的错误信息做了一下搜索，并找到了文件出处：</p>

<blockquote>
  <p>./gdb/linux-thread-db.c:1431:   error (_(“Cannot get thread event message: %s”),</p>
</blockquote>

<p>这段代码里有几段注释是比较有价值的，我截取了部分代码(完整的函数代码我放到了文章末尾):</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
</pre></td><td class="rouge-code"><pre><span class="cm">/* Check if PID is currently stopped at the location of a thread event
   breakpoint location.  If it is, read the event message and act upon
   the event.  */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">check_event</span> <span class="p">(</span><span class="n">ptid_t</span> <span class="n">ptid</span><span class="p">)</span>
<span class="p">{</span>
    <span class="cm">/* If we have only looked at the first thread before libpthread was
     initialized, we may not know its thread ID yet.  Make sure we do
     before we add another thread to the list.  */</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">have_threads</span> <span class="p">(</span><span class="n">ptid</span><span class="p">))</span>
    <span class="n">thread_db_find_new_threads_1</span> <span class="p">(</span><span class="n">ptid</span><span class="p">);</span>

  <span class="cm">/* If we are at a create breakpoint, we do not know what new lwp
     was created and cannot specifically locate the event message for it.
     We have to call td_ta_event_getmsg() to get
     the latest message.  Since we have no way of correlating whether
     the event message we get back corresponds to our breakpoint, we must
     loop and read all event messages, processing them appropriately.
     This guarantees we will process the correct message before continuing
     from the breakpoint.

     Currently, death events are not enabled.  If they are enabled,
     the death event can use the td_thr_event_getmsg() interface to
     get the message specifically for that lwp and avoid looping
     below.  */</span>

  <span class="n">loop</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

  <span class="k">do</span>
    <span class="p">{</span>
      <span class="n">err</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">td_ta_event_getmsg_p</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">thread_agent</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">!=</span> <span class="n">TD_OK</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="n">TD_NOMSG</span><span class="p">)</span>
        <span class="k">return</span><span class="p">;</span>

      <span class="n">error</span> <span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">"Cannot get thread event message: %s"</span><span class="p">),</span>
         <span class="n">thread_db_err_str</span> <span class="p">(</span><span class="n">err</span><span class="p">));</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>“Cannot get thread event message: debugger service failed”就是check_event函数抛出来的错误，这个函数的作用是读取gdb打断点时的线程信息，但是对于gdb来说，它本身不知道线程什么时候创建，所以在gdb程序里它时通过循环调用td_ta_event_getmsg_p来读取线程信息，再结合上述我们查阅到的资料，不难得出一个猜测：</p>

<p>在一个程序里大量的创建一些短线程(线程内部只是执行几个小函数就结束)，与此同时我们在这些线程的函数体内里埋下一个端点，会不会出现复现上述的问题呢？</p>

<h3 id="写测试代码验证">写测试代码验证</h3>

<p>有了上述的猜测，我们可以写一段代码来做一下大胆的验证，测试代码如下：</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
</pre></td><td class="rouge-code"><pre><span class="cp">#include</span> <span class="cpf">&lt;thread&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;iostream&gt;</span><span class="cp">
</span>
<span class="kt">int</span> <span class="nf">plus</span><span class="p">(</span><span class="kt">int</span> <span class="n">a</span><span class="p">,</span> <span class="kt">int</span> <span class="n">b</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">a</span> <span class="o">&lt;&lt;</span> <span class="s">" + "</span> <span class="o">&lt;&lt;</span> <span class="n">b</span> <span class="o">&lt;&lt;</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span><span class="p">;</span>
<span class="p">}</span>
<span class="kt">int</span> <span class="nf">substract</span><span class="p">(</span><span class="kt">int</span> <span class="n">a</span><span class="p">,</span> <span class="kt">int</span> <span class="n">b</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">a</span> <span class="o">&lt;&lt;</span> <span class="s">" - "</span> <span class="o">&lt;&lt;</span> <span class="n">b</span> <span class="o">&lt;&lt;</span> <span class="n">a</span> <span class="o">-</span> <span class="n">b</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">a</span> <span class="o">-</span> <span class="n">b</span><span class="p">;</span>
<span class="p">}</span>
<span class="kt">int</span> <span class="nf">multiply</span><span class="p">(</span><span class="kt">int</span> <span class="n">a</span><span class="p">,</span> <span class="kt">int</span> <span class="n">b</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">a</span> <span class="o">&lt;&lt;</span> <span class="s">" * "</span> <span class="o">&lt;&lt;</span> <span class="n">b</span> <span class="o">&lt;&lt;</span> <span class="n">a</span> <span class="o">*</span> <span class="n">b</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">a</span> <span class="o">*</span> <span class="n">b</span><span class="p">;</span>
<span class="p">}</span>
<span class="kt">int</span> <span class="nf">divide</span><span class="p">(</span><span class="kt">int</span> <span class="n">a</span><span class="p">,</span> <span class="kt">int</span> <span class="n">b</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">a</span> <span class="o">&lt;&lt;</span> <span class="s">" / "</span> <span class="o">&lt;&lt;</span> <span class="n">b</span> <span class="o">&lt;&lt;</span> <span class="n">a</span> <span class="o">/</span> <span class="n">b</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">a</span> <span class="o">/</span> <span class="n">b</span><span class="p">;</span>
<span class="p">}</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">while</span> <span class="p">(</span><span class="nb">true</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">std</span><span class="o">::</span><span class="kr">thread</span> <span class="n">t1</span><span class="p">(</span><span class="n">plus</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
        <span class="n">std</span><span class="o">::</span><span class="kr">thread</span> <span class="n">t2</span><span class="p">(</span><span class="n">substract</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
        <span class="n">std</span><span class="o">::</span><span class="kr">thread</span> <span class="n">t3</span><span class="p">(</span><span class="n">multiply</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
        <span class="n">std</span><span class="o">::</span><span class="kr">thread</span> <span class="n">t4</span><span class="p">(</span><span class="n">divide</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
        <span class="n">t1</span><span class="p">.</span><span class="n">join</span><span class="p">();</span>
        <span class="n">t2</span><span class="p">.</span><span class="n">join</span><span class="p">();</span>
        <span class="n">t3</span><span class="p">.</span><span class="n">join</span><span class="p">();</span>
        <span class="n">t4</span><span class="p">.</span><span class="n">join</span><span class="p">();</span>
        <span class="n">std</span><span class="o">::</span><span class="n">this_thread</span><span class="o">::</span><span class="n">sleep_for</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">milliseconds</span><span class="p">(</span><span class="mi">10</span><span class="p">));</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>运行上述编译的程序，使用gdb attach到进程，执行调试时，果然问题很容易就复现了：</p>

<p><img src="http://www.techplorer.cn/upload/2021/04/gdb_bug-6c70da570a4a4374815f778f82d1c4b9.png" alt="gdb_bug" /></p>

<h3 id="总结">总结</h3>

<p>虽然上述的问题是来自于gdb的bug，但从中也引申出另外一个问题：那就是去检查一下我们的项目代码里是不是存在大量创建短线程的情况。一般的，我们都尽量避免用这种方式写代码，一方面是用线程池的方案可以解决并发的问题，另一方面反复创建短线程也是一种对资源和性能的消耗。</p>

<h3 id="参考资料">参考资料</h3>

<ul>
  <li>
    <p>https://stackoverflow.com/questions/16814706/how-does-gdb-attach-to-multi-threaded-process</p>
  </li>
  <li>
    <p>./gdb/linux-thread-db.c:  static void  check_event (ptid_t ptid)</p>
  </li>
</ul>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
</pre></td><td class="rouge-code"><pre><span class="cm">/* Check if PID is currently stopped at the location of a thread event
   breakpoint location.  If it is, read the event message and act upon
   the event.  */</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">check_event</span> <span class="p">(</span><span class="n">ptid_t</span> <span class="n">ptid</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">struct</span> <span class="n">regcache</span> <span class="o">*</span><span class="n">regcache</span> <span class="o">=</span> <span class="n">get_thread_regcache</span> <span class="p">(</span><span class="n">ptid</span><span class="p">);</span>
  <span class="k">struct</span> <span class="n">gdbarch</span> <span class="o">*</span><span class="n">gdbarch</span> <span class="o">=</span> <span class="n">get_regcache_arch</span> <span class="p">(</span><span class="n">regcache</span><span class="p">);</span>
  <span class="n">td_event_msg_t</span> <span class="n">msg</span><span class="p">;</span>
  <span class="n">td_thrinfo_t</span> <span class="n">ti</span><span class="p">;</span>
  <span class="n">td_err_e</span> <span class="n">err</span><span class="p">;</span>
  <span class="n">CORE_ADDR</span> <span class="n">stop_pc</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">loop</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">struct</span> <span class="n">thread_db_info</span> <span class="o">*</span><span class="n">info</span><span class="p">;</span>

  <span class="n">info</span> <span class="o">=</span> <span class="n">get_thread_db_info</span> <span class="p">(</span><span class="n">GET_PID</span> <span class="p">(</span><span class="n">ptid</span><span class="p">));</span>

  <span class="cm">/* Bail out early if we're not at a thread event breakpoint.  */</span>
  <span class="n">stop_pc</span> <span class="o">=</span> <span class="n">regcache_read_pc</span> <span class="p">(</span><span class="n">regcache</span><span class="p">)</span>
        <span class="o">-</span> <span class="n">gdbarch_decr_pc_after_break</span> <span class="p">(</span><span class="n">gdbarch</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">stop_pc</span> <span class="o">!=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">td_create_bp_addr</span>
      <span class="o">&amp;&amp;</span> <span class="n">stop_pc</span> <span class="o">!=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">td_death_bp_addr</span><span class="p">)</span>
    <span class="k">return</span><span class="p">;</span>

  <span class="cm">/* Access an lwp we know is stopped.  */</span>
  <span class="n">info</span><span class="o">-&gt;</span><span class="n">proc_handle</span><span class="p">.</span><span class="n">ptid</span> <span class="o">=</span> <span class="n">ptid</span><span class="p">;</span>

  <span class="cm">/* If we have only looked at the first thread before libpthread was
     initialized, we may not know its thread ID yet.  Make sure we do
     before we add another thread to the list.  */</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">have_threads</span> <span class="p">(</span><span class="n">ptid</span><span class="p">))</span>
    <span class="n">thread_db_find_new_threads_1</span> <span class="p">(</span><span class="n">ptid</span><span class="p">);</span>

  <span class="cm">/* If we are at a create breakpoint, we do not know what new lwp
     was created and cannot specifically locate the event message for it.
     We have to call td_ta_event_getmsg() to get
     the latest message.  Since we have no way of correlating whether
     the event message we get back corresponds to our breakpoint, we must
     loop and read all event messages, processing them appropriately.
     This guarantees we will process the correct message before continuing
     from the breakpoint.

     Currently, death events are not enabled.  If they are enabled,
     the death event can use the td_thr_event_getmsg() interface to
     get the message specifically for that lwp and avoid looping
     below.  */</span>

  <span class="n">loop</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

  <span class="k">do</span>
    <span class="p">{</span>
      <span class="n">err</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">td_ta_event_getmsg_p</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">thread_agent</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">!=</span> <span class="n">TD_OK</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="n">TD_NOMSG</span><span class="p">)</span>
        <span class="k">return</span><span class="p">;</span>

      <span class="n">error</span> <span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">"Cannot get thread event message: %s"</span><span class="p">),</span>
         <span class="n">thread_db_err_str</span> <span class="p">(</span><span class="n">err</span><span class="p">));</span>
    <span class="p">}</span>

      <span class="n">err</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">td_thr_get_info_p</span> <span class="p">(</span><span class="n">msg</span><span class="p">.</span><span class="n">th_p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ti</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">!=</span> <span class="n">TD_OK</span><span class="p">)</span>
    <span class="n">error</span> <span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">"Cannot get thread info: %s"</span><span class="p">),</span> <span class="n">thread_db_err_str</span> <span class="p">(</span><span class="n">err</span><span class="p">));</span>

      <span class="n">ptid</span> <span class="o">=</span> <span class="n">ptid_build</span> <span class="p">(</span><span class="n">GET_PID</span> <span class="p">(</span><span class="n">ptid</span><span class="p">),</span> <span class="n">ti</span><span class="p">.</span><span class="n">ti_lid</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

      <span class="k">switch</span> <span class="p">(</span><span class="n">msg</span><span class="p">.</span><span class="n">event</span><span class="p">)</span>
    <span class="p">{</span>
    <span class="k">case</span> <span class="n">TD_CREATE</span><span class="p">:</span>
      <span class="cm">/* Call attach_thread whether or not we already know about a
         thread with this thread ID.  */</span>
      <span class="n">attach_thread</span> <span class="p">(</span><span class="n">ptid</span><span class="p">,</span> <span class="n">msg</span><span class="p">.</span><span class="n">th_p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ti</span><span class="p">);</span>

      <span class="k">break</span><span class="p">;</span>

    <span class="k">case</span> <span class="n">TD_DEATH</span><span class="p">:</span>

      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">in_thread_list</span> <span class="p">(</span><span class="n">ptid</span><span class="p">))</span>
        <span class="n">error</span> <span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">"Spurious thread death event."</span><span class="p">));</span>

      <span class="n">detach_thread</span> <span class="p">(</span><span class="n">ptid</span><span class="p">);</span>

      <span class="k">break</span><span class="p">;</span>

    <span class="nl">default:</span>
      <span class="n">error</span> <span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">"Spurious thread event."</span><span class="p">));</span>
    <span class="p">}</span>
    <span class="p">}</span>
  <span class="k">while</span> <span class="p">(</span><span class="n">loop</span><span class="p">);</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>


                <hr style="visibility: hidden;">
                <ul class="pager">
                    
                    <li class="previous">
                        <a href="/2021/04/05/Trie-algorithm/" data-toggle="tooltip" data-placement="top" title="Trie的算法实现">
                        Previous<br>
                        <span>Trie的算法实现</span>
                        </a>
                    </li>
                    
                    
                    <li class="next">
                        <a href="/2021/04/11/3-years-learninng-english/" data-toggle="tooltip" data-placement="top" title="英文学习">
                        Next<br>
                        <span>英文学习</span>
                        </a>
                    </li>
                    
                </ul>
                <hr style="visibility: hidden;">

                

                
            </div>  

    <!-- Side Catalog Container -->
        
            <div class="
                col-lg-2 col-lg-offset-0
                visible-lg-block
                sidebar-container
                catalog-container">
                <div class="side-catalog">
                    <hr class="hidden-sm hidden-xs">
                    <h5>
                        <a class="catalog-toggle" href="#">CATALOG</a>
                    </h5>
                    <ul class="catalog-body"></ul>
                </div>
            </div>
        

    <!-- Sidebar Container -->
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                sidebar-container">

                <!-- Featured Tags -->
                


<section>
    
        <hr class="hidden-sm hidden-xs">
    
    <h5><a href="/archive/">FEATURED TAGS</a></h5>
    <div class="tags">
        
        
        
        
        
        
                <a data-sort="0028" 
                    href="/archive/?tag=%E8%A2%AB%E5%A4%B9"
                    title="被夹"
                    rel="5">被夹</a>
        
                <a data-sort="0024" 
                    href="/archive/?tag=%E7%AE%97%E6%B3%95"
                    title="算法"
                    rel="9">算法</a>
        
                <a data-sort="0028" 
                    href="/archive/?tag=c%2B%2B"
                    title="c++"
                    rel="5">c++</a>
        
                <a data-sort="0029" 
                    href="/archive/?tag=%E6%84%9F%E6%82%9F"
                    title="感悟"
                    rel="4">感悟</a>
        
                <a data-sort="0031" 
                    href="/archive/?tag=%E7%BC%96%E7%A8%8B%E6%80%9D%E6%83%B3"
                    title="编程思想"
                    rel="2">编程思想</a>
        
                <a data-sort="0031" 
                    href="/archive/?tag=go"
                    title="go"
                    rel="2">go</a>
    </div>
</section>


                <!-- Friends Blog -->
                
<hr>
<h5>FRIENDS</h5>
<ul class="list-inline">
  
  <li><a href=""></a></li>
  
</ul>

            </div>
        </div>
    </div>
</article>

<!-- add support for mathjax by voleking-->









<!-- async load function -->
<script>
    function async(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>
<!-- anchor-js, Doc:http://bryanbraun.github.io/anchorjs/ -->
<script>
    async("//cdnjs.cloudflare.com/ajax/libs/anchor-js/1.1.1/anchor.min.js",function(){
        anchors.options = {
          visible: 'hover',
          placement: 'right',
          // icon: '#'
        };
        anchors.add().remove('.intro-header h1').remove('.subheading').remove('.sidebar-container h5');
    })
</script>
<style>
    /* place left on bigger screen */
    @media all and (min-width: 800px) {
        .anchorjs-link{
            position: absolute;
            left: -0.75em;
            font-size: 1.1em;
            margin-top : -0.1em;
        }
    }
</style>



    <!-- Footer -->
<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <!-- SNS Link -->
                


<ul class="list-inline text-center">


  
  
  
  
  
  
  
</ul>

                <p class="copyright text-muted">
                    Copyright &copy; Fusha Blog 2022
                    <br>
                    Powered by <a href="https://www.techplorer.cn/">Fusha Blog</a>
                </p>
            </div>
        </div>
    </div>
</footer>

<!-- jQuery -->
<script src="/js/jquery.min.js "></script>

<!-- Bootstrap Core JavaScript -->
<!-- Currently, only navbar scroll-down effect at desktop still depends on this -->
<script src="/js/bootstrap.min.js "></script>

<!-- Custom Theme JavaScript -->
<script src="/js/hux-blog.min.js "></script>

<!-- Simple Jekyll Search -->
<script src="/js/simple-jekyll-search.min.js"></script>

<!-- Service Worker -->

<script src="/js/snackbar.js "></script>
<script src="/js/sw-registration.js "></script>


<!-- async load function -->
<script>
    function async(u, c) {
        var d = document, t = 'script',
            o = d.createElement(t),
            s = d.getElementsByTagName(t)[0];
        o.src = u;
        if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
        s.parentNode.insertBefore(o, s);
    }
</script>

<!--
     Because of the native support for backtick-style fenced code blocks
     right within the Markdown is landed in Github Pages,
     From V1.6, There is no need for Highlight.js,
     so Huxblog drops it officially.

     - https://github.com/blog/2100-github-pages-now-faster-and-simpler-with-jekyll-3-0
     - https://help.github.com/articles/creating-and-highlighting-code-blocks/
     - https://github.com/jneen/rouge/wiki/list-of-supported-languages-and-lexers
-->
<!--
    <script>
        async("http://cdn.bootcss.com/highlight.js/8.6/highlight.min.js", function(){
            hljs.initHighlightingOnLoad();
        })
    </script>
    <link href="http://cdn.bootcss.com/highlight.js/8.6/styles/github.min.css" rel="stylesheet">
-->







<!--fastClick.js -->
<script>
    async("//cdnjs.cloudflare.com/ajax/libs/fastclick/1.0.6/fastclick.min.js", function () {
        var $nav = document.querySelector("nav");
        if ($nav) FastClick.attach($nav);
    })
</script>


<!-- Google Analytics -->

<script>
    // dynamic User by Hux
    var _gaId = 'UA-49627206-1';
    var _gaDomain = 'huangxuan.me';

    // Originial
    (function (i, s, o, g, r, a, m) {
        i['GoogleAnalyticsObject'] = r; i[r] = i[r] || function () {
            (i[r].q = i[r].q || []).push(arguments)
        }, i[r].l = 1 * new Date(); a = s.createElement(o),
            m = s.getElementsByTagName(o)[0]; a.async = 1; a.src = g; m.parentNode.insertBefore(a, m)
    })(window, document, 'script', '//www.google-analytics.com/analytics.js', 'ga');

    ga('create', _gaId, _gaDomain);
    ga('send', 'pageview');
</script>



<!-- Baidu Tongji -->



<!-- Side Catalog -->

<script type="text/javascript">
    function generateCatalog(selector) {

        // interop with multilangual 
        if ('' == 'true') {
            _containerSelector = 'div.post-container.active'
        } else {
            _containerSelector = 'div.post-container'
        }

        // init
        var P = $(_containerSelector), a, n, t, l, i, c;
        a = P.find('h1,h2,h3,h4,h5,h6');

        // clean
        $(selector).html('')

        // appending
        a.each(function () {
            n = $(this).prop('tagName').toLowerCase();
            i = "#" + $(this).prop('id');
            t = $(this).text();
            c = $('<a href="' + i + '" rel="nofollow">' + t + '</a>');
            l = $('<li class="' + n + '_nav"></li>').append(c);
            $(selector).append(l);
        });
        return true;
    }

    generateCatalog(".catalog-body");

    // toggle side catalog
    $(".catalog-toggle").click((function (e) {
        e.preventDefault();
        $('.side-catalog').toggleClass("fold")
    }))

    /*
     * Doc: https://github.com/davist11/jQuery-One-Page-Nav
     * Fork by Hux to support padding
     */
    async("/js/jquery.nav.js", function () {
        $('.catalog-body').onePageNav({
            currentClass: "active",
            changeHash: !1,
            easing: "swing",
            filter: "",
            scrollSpeed: 700,
            scrollOffset: 0,
            scrollThreshold: .2,
            begin: null,
            end: null,
            scrollChange: null,
            padding: 80
        });
    });
</script>



<!-- Multi-Lingual -->


<!-- Simple Jekyll Search -->
<script>
    // https://stackoverflow.com/questions/1912501/unescape-html-entities-in-javascript
    function htmlDecode(input) {
        var e = document.createElement('textarea');
        e.innerHTML = input;
        // handle case of empty input
        return e.childNodes.length === 0 ? "" : e.childNodes[0].nodeValue;
    }

    SimpleJekyllSearch({
        searchInput: document.getElementById('search-input'),
        resultsContainer: document.getElementById('search-results'),
        json: '/search.json',
        searchResultTemplate: '<div class="post-preview item"><a href="{url}"><h2 class="post-title">{title}</h2><h3 class="post-subtitle">{subtitle}</h3><hr></a></div>',
        noResultsText: 'No results',
        limit: 50,
        fuzzy: false,
        // a hack to get escaped subtitle unescaped. for some reason, 
        // post.subtitle w/o escape filter nuke entire search.
        templateMiddleware: function (prop, value, template) {
            if (prop === 'subtitle' || prop === 'title') {
                if (value.indexOf("code")) {
                    return htmlDecode(value);
                } else {
                    return value;
                }
            }
        }
    });

    $(document).ready(function () {
        var $searchPage = $('.search-page');
        var $searchOpen = $('.search-icon');
        var $searchClose = $('.search-icon-close');
        var $searchInput = $('#search-input');
        var $body = $('body');

        $searchOpen.on('click', function (e) {
            e.preventDefault();
            $searchPage.toggleClass('search-active');
            var prevClasses = $body.attr('class') || '';
            setTimeout(function () {
                $body.addClass('no-scroll');
            }, 400)

            if ($searchPage.hasClass('search-active')) {
                $searchClose.on('click', function (e) {
                    e.preventDefault();
                    $searchPage.removeClass('search-active');
                    $body.attr('class', prevClasses);  // from closure 
                });
                $searchInput.focus();
            }
        });
    });
</script>



<!-- Image to hack wechat -->
<img src="/img/icon_wechat.png" width="0" height="0" />
<!-- Migrate from head to bottom, no longer block render and still work -->

</body>

</html>
