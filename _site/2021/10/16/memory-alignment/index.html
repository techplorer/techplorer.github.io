<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="google-site-verification" content="xBT4GhYoi5qRD5tr338pgPM5OWHHIDR6mNg1a3euekI" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
    <meta name="description" content="这里是 周海军 的个人博客">
    <meta name="keywords" content="周海军, Fusha, navy, @navy, 周海军的博客, Fusha Blog, 博客, 个人网站, 互联网, 后端, 设计">
    <meta name="theme-color" content="#000000">

    <!-- Open Graph -->
    <meta property="og:title"
        content="内存对齐 - 孚沙的博客 | Fusha Blog">
    
    <meta property="og:type" content="article">
    <meta property="og:description" content="术语定义
">
    
    <meta property="article:published_time" content=" 2021-10-16T05:00:00Z">
    
    
    <meta property="article:author" content="zhouhaijun">
    
    
    <meta property="article:tag" content="内存对齐">
    
    
    <meta property="og:image" content="http://localhost:4000">
    <meta property="og:url" content="http://localhost:4000/2021/10/16/memory-alignment/">
    <meta property="og:site_name" content="孚沙的博客 | Fusha Blog">

    <title>内存对齐 - 孚沙的博客 | Fusha Blog</title>

    <!-- Web App Manifest -->
    <link rel="manifest" href="/pwa/manifest.json">

    <!-- Favicon -->
    <link rel="shortcut icon" href="/img/favicon.ico">

    <!-- Canonical URL -->
    <link rel="canonical" href="http://localhost:4000/2021/10/16/memory-alignment/">

    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href=" /css/bootstrap.min.css">

    <!-- Custom CSS -->
    <link rel="stylesheet" href=" /css/hux-blog.min.css">

    <!-- Custom Fonts -->
    <!-- <link href="http://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet" type="text/css"> -->
    <!-- Hux change font-awesome CDN to qiniu -->
    <link href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet"
        type="text/css">


    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- ga & ba script hoook -->
    <script></script>

    <!-- Google AdSense -->
    <script data-ad-client="ca-pub-6487568398225121" async
        src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
</head>


<!-- hack iOS CSS :active style -->
<body ontouchstart="">

    <!-- Navigation -->

<nav class="navbar navbar-default navbar-custom navbar-fixed-top invert">
    
        <div class="container-fluid">
            <!-- Brand and toggle get grouped for better mobile display -->
            <div class="navbar-header page-scroll">
                <button type="button" class="navbar-toggle">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand" href="/">Fusha Blog</a>
            </div>

            <!-- Collect the nav links, forms, and other content for toggling -->
            <div id="huxblog_navbar">
                <div class="navbar-collapse">
                    <ul class="nav navbar-nav navbar-right">
                        <li>
                            <a href="/">Home</a>
                        </li>
                        
                        
                        
                        
                        <li>
                            <a href="/about/">About</a>
                        </li>
                        
                        
                        
                        <li>
                            <a href="/archive/">Archive</a>
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        <li class="search-icon">
                            <a href="javascript:void(0)">
                                <i class="fa fa-search"></i>
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
            <!-- /.navbar-collapse -->
        </div>
        <!-- /.container -->
    </nav>

    <script>
        // Drop Bootstarp low-performance Navbar
        // Use customize navbar with high-quality material design animation
        // in high-perf jank-free CSS3 implementation
        var $body = document.body;
        var $toggle = document.querySelector('.navbar-toggle');
        var $navbar = document.querySelector('#huxblog_navbar');
        var $collapse = document.querySelector('.navbar-collapse');

        var __HuxNav__ = {
            close: function () {
                $navbar.className = " ";
                // wait until animation end.
                setTimeout(function () {
                    // prevent frequently toggle
                    if ($navbar.className.indexOf('in') < 0) {
                        $collapse.style.height = "0px"
                    }
                }, 400)
            },
            open: function () {
                $collapse.style.height = "auto"
                $navbar.className += " in";
            }
        }

        // Bind Event
        $toggle.addEventListener('click', function (e) {
            if ($navbar.className.indexOf('in') > 0) {
                __HuxNav__.close()
            } else {
                __HuxNav__.open()
            }
        })

        /**
         * Since Fastclick is used to delegate 'touchstart' globally
         * to hack 300ms delay in iOS by performing a fake 'click',
         * Using 'e.stopPropagation' to stop 'touchstart' event from 
         * $toggle/$collapse will break global delegation.
         * 
         * Instead, we use a 'e.target' filter to prevent handler
         * added to document close HuxNav.  
         *
         * Also, we use 'click' instead of 'touchstart' as compromise
         */
        document.addEventListener('click', function (e) {
            if (e.target == $toggle) return;
            if (e.target.className == 'icon-bar') return;
            __HuxNav__.close();
        })
    </script>
    <!-- Search -->
<div class="search-page">
  <div class="search-icon-close-container">
    <span class="search-icon-close">
      <i class="fa fa-chevron-down"></i>
    </span>
  </div>
  <div class="search-main container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <form></form>
        <input type="text" id="search-input" placeholder="$ grep...">
        </form>
        <div id="search-results" class="mini-post-list"></div>
      </div>
    </div>
  </div>
</div>

    <!-- Image to hack wechat -->
<!-- <img src="/img/icon_wechat.png" width="0" height="0"> -->
<!-- <img src="/img/home-bg.jpg" width="0" height="0"> -->

<!-- Post Header -->



<style type="text/css">
    header.intro-header{
        position: relative;
        background-image: url('/img/home-bg.jpg');
        background: ;
    }

    
</style>

<header class="intro-header style-text" >

    <div class="header-mask"></div>
    
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-heading">
                    <div class="tags">
                        
                        <a class="tag" href="/archive/?tag=%E5%86%85%E5%AD%98%E5%AF%B9%E9%BD%90" title="内存对齐">内存对齐</a>
                        
                    </div>
                    <h1>内存对齐</h1>
                    
                    <h2 class="subheading">memory alignment</h2>
                    <span class="meta">Posted by zhouhaijun on October 16, 2021</span>
                </div>
            </div>
        </div>
    </div>
</header>






<!-- Post Content -->
<article>
    <div class="container">
        <div class="row">

    <!-- Post Container -->
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                post-container">

                <!-- Multi-Lingual -->
                

				<h3 id="术语定义">术语定义</h3>

<ul>
  <li>naturally aligned</li>
</ul>

<p>参考自http://books.gigatux.nl/mirror/kerneldevelopment/0672327201/ch19lev1sec3.html</p>

<blockquote>
  <p>A variable is <em>naturally aligned</em> if it exists at a memory address that is a multiple of its size. For example, a 32-bit type is naturally aligned if it is located in memory at an address that is a multiple of four (that is, its lowest two bits are zero). Thus, a data type with size 2<em>n</em> bytes must have an address with the <em>n</em> least significant bits set to zero.</p>
</blockquote>

<p>当访问一块N字节的内存变量时，若访问的内存地址能被N整除，则称该内存地址是 naturally aligned。</p>

<ul>
  <li>data alignment</li>
</ul>

<p>参考自https://en.m.wikipedia.org/wiki/Data_structure_alignment</p>

<blockquote>
  <p>Data alignment is the aligning of elements according to their natural alignment. To ensure natural alignment, it may be necessary to insert some padding between structure elements or after the last element of a structure. For example, on a 32-bit machine, a data structure containing a 16-bit value followed by a 32-bit value could have 16 bits of padding between the 16-bit value and the 32-bit value to align the 32-bit value on a 32-bit boundary. Alternatively, one can pack the structure, omitting the padding, which may lead to slower access, but uses three quarters as much memory.</p>
</blockquote>

<p>举例来说，在linux x86平台下，定义了如下的结构体：</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre>struct mystruct {
    char c; // 1 byte
    short s; // 2 byte
    int i; // 4 byte
};
</pre></td></tr></tbody></table></code></pre></div></div>

<p>按照上述<em>naturally aligned</em>的定义，如果要访问占用1字节的c的内存地址，无论如何都是naturally aligned，但此时访问占用2字节的s却无法满足naturally aligned，解决的办法就是在c后面插入1个字节(也叫padding)，使得c和s一共占用4字节，而对于i来说，刚好也满足naturally aligned，这样一来结构体的所有变量内存地址就都满足naturally aligned，我们称这样的结构体为data alignment。</p>

<ul>
  <li>memory access granularity  vs  memory access boundary</li>
</ul>

<p>参考自https://stackoverflow.com/questions/16620226/double-byte-memory-access-granularity</p>

<blockquote>
  <p><em>Memory access granularity</em> is the number of bytes it accesses at a time, and a <em>memory access boundary</em> is where each of these groups of bytes begins.</p>
</blockquote>

<p>cpu需要从内存加载数据，那么cpu访问一次内存获取的数据大小，称之为memory access granularity，单位是byte，比如68000下是2字节，68030 和PowerPC® 601是4字节。</p>

<h3 id="什么是内存对齐">什么是内存对齐</h3>

<p>有了上述<em>naturally aligned</em>和<em>data alignment</em>的定义，便不难理解什么是内存对齐，这里举出一个反例：</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre>    char dog[10];
    char *p = &amp;dog[1];
    unsigned long l = *(unsigned long *)p;
</pre></td></tr></tbody></table></code></pre></div></div>

<p>上述代码里，指向char的指针被强转为unsigned long型，此时访问变量l，便有可能会造成内存不对齐的问题。</p>

<h3 id="为什么需要内存对齐">为什么需要内存对齐</h3>

<p>一般的，编程中大多数内存不对齐的问题都会在编译器这一层解决了，但是出于好奇，我们也会想知道为什么要做内存对齐，或者说内存对齐带来了哪些好处？</p>

<ul>
  <li>访问速度</li>
</ul>

<p>假设我们现在用的是PowerPC® 601，其memory access granularity是4字节，（下图来自https://developer.ibm.com/technologies/systems/articles/pa-dalign/)是分别从0x0和0x1读取4字节的示意图：</p>

<p><img src="/img/in-post/zhouhaijun-pic/memory_alig_1.jpeg" alt="" /></p>

<p>从图中可以看出，当从地址0x0读取4字节只需要一次读取即可，但是从地址0x1读取4字节，就需要2次，具体过程如下图：</p>

<p><img src="/img/in-post/zhouhaijun-pic/unalignedAccess.jpeg" alt="" /></p>

<ul class="task-list">
  <li class="task-list-item"><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" />第一步从0x0读取4字节，获取字节0x1~0x3；</li>
  <li class="task-list-item"><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" />第二步从0x4读取4字节，获取字节0x4；</li>
  <li class="task-list-item"><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" />两次读取后的数据再做一次聚合；</li>
</ul>

<p>由此得知，内存不对齐会导致访问内存的频次变高，一是降低了访问速度，另外一个是增加了总线带宽的消耗。</p>

<ul>
  <li>原子性</li>
</ul>

<p>当前的很多处理器都提供了一些原子操作的指令，在使用这些指令去访问内存时，如果提供的地址没有满足内存对齐，会导致的访问的内存变成多次，进而原子的语义就会被破坏。</p>

<ul>
  <li>兼容性问题</li>
</ul>

<p>在x86的平台下我们借助pragma指令可以强制编译器修改默认对齐字节数，是因为x86的处理器可以访问不对齐的内存，但在其他的处理器上，例如68000 下cpu访问不对齐的地址时会抛出异常，在Sun SPARC下访问未对齐的内存程序会crash。</p>

<h3 id="结构体内存对齐规则">结构体内存对齐规则</h3>

<ul>
  <li>对齐规则</li>
</ul>

<p>N=min(结构体最宽的成员大小，指定编译器对齐大小)，注意制定编译器对齐大小只能是2的幂，比如1、2、4字节，实际编程中尽量不要使用pragma来制定编译器对齐大小，可能会导致不同平台下的兼容性问题：</p>

<ul class="task-list">
  <li class="task-list-item"><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" />结构体变量的起始地址能够被N整除；</li>
  <li class="task-list-item"><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" />结构体每个成员相对于起始地址的偏移能够被其自身大小整除，如果不能则在前一个成员后面补充字节；</li>
  <li class="task-list-item">
    <p><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" />结构体总体大小能够被N整除，如不能则在后面补充字节；</p>
  </li>
  <li class="task-list-item">实例</li>
</ul>

<p>定义如下结构体，在linux  x86平台下的内存布局为：</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre>struct mystruct {
    bool a;
    // 为确保访问b的内存对齐，此处插入1字节
    short b;
    // 为确保访问c时内存对齐，此处插入4字节
    long long c; // 成员变量最宽字节数，8字节
    bool d;
    // 为确保数组元素的下一个结构体首地址内存对齐，此处插入7字节
};
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="参考资料">参考资料</h3>

<p>内存对齐</p>

<ul>
  <li>https://developer.ibm.com/technologies/systems/articles/pa-dalign/</li>
  <li>https://en.m.wikipedia.org/wiki/Data_structure_alignment</li>
</ul>

<p>为什么memory access boundary is power of 2</p>

<ul>
  <li>https://stackoverflow.com/questions/64415023/why-cpu-accesses-aligned-memory</li>
  <li>https://stackoverflow.com/questions/3655926/why-does-cpu-access-memory-on-a-word-boundary</li>
</ul>


                <hr style="visibility: hidden;">
                <ul class="pager">
                    
                    <li class="previous">
                        <a href="/2021/09/20/dfs-vs-bfs/" data-toggle="tooltip" data-placement="top" title="深度与广度优先搜索代码模板">
                        Previous<br>
                        <span>深度与广度优先搜索代码模板</span>
                        </a>
                    </li>
                    
                    
                    <li class="next">
                        <a href="/2021/10/20/thinking-about-programing/" data-toggle="tooltip" data-placement="top" title="关于从事编程工作的思考(一)">
                        Next<br>
                        <span>关于从事编程工作的思考(一)</span>
                        </a>
                    </li>
                    
                </ul>
                <hr style="visibility: hidden;">

                

                
            </div>  

    <!-- Side Catalog Container -->
        
            <div class="
                col-lg-2 col-lg-offset-0
                visible-lg-block
                sidebar-container
                catalog-container">
                <div class="side-catalog">
                    <hr class="hidden-sm hidden-xs">
                    <h5>
                        <a class="catalog-toggle" href="#">CATALOG</a>
                    </h5>
                    <ul class="catalog-body"></ul>
                </div>
            </div>
        

    <!-- Sidebar Container -->
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                sidebar-container">

                <!-- Featured Tags -->
                


<section>
    
        <hr class="hidden-sm hidden-xs">
    
    <h5><a href="/archive/">FEATURED TAGS</a></h5>
    <div class="tags">
        
        
        
        
        
        
                <a data-sort="0020" 
                    href="/archive/?tag=%E8%A2%AB%E5%A4%B9"
                    title="被夹"
                    rel="10">被夹</a>
        
                <a data-sort="0022" 
                    href="/archive/?tag=%E7%AE%97%E6%B3%95"
                    title="算法"
                    rel="8">算法</a>
        
                <a data-sort="0027" 
                    href="/archive/?tag=%E6%84%9F%E6%82%9F"
                    title="感悟"
                    rel="3">感悟</a>
        
                <a data-sort="0027" 
                    href="/archive/?tag=c%2B%2B"
                    title="c++"
                    rel="3">c++</a>
    </div>
</section>


                <!-- Friends Blog -->
                
<hr>
<h5>FRIENDS</h5>
<ul class="list-inline">
  
  <li><a href=""></a></li>
  
</ul>

            </div>
        </div>
    </div>
</article>

<!-- add support for mathjax by voleking-->









<!-- async load function -->
<script>
    function async(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>
<!-- anchor-js, Doc:http://bryanbraun.github.io/anchorjs/ -->
<script>
    async("//cdnjs.cloudflare.com/ajax/libs/anchor-js/1.1.1/anchor.min.js",function(){
        anchors.options = {
          visible: 'hover',
          placement: 'right',
          // icon: '#'
        };
        anchors.add().remove('.intro-header h1').remove('.subheading').remove('.sidebar-container h5');
    })
</script>
<style>
    /* place left on bigger screen */
    @media all and (min-width: 800px) {
        .anchorjs-link{
            position: absolute;
            left: -0.75em;
            font-size: 1.1em;
            margin-top : -0.1em;
        }
    }
</style>



    <!-- Footer -->
<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <!-- SNS Link -->
                


<ul class="list-inline text-center">


  
  
  
  
  
  
  
</ul>

                <p class="copyright text-muted">
                    Copyright &copy; Fusha Blog 2022
                    <br>
                    Powered by <a href="http://techplorer.cn">Fusha Blog</a> |
                    <iframe style="margin-left: 2px; margin-bottom:-5px;" frameborder="0" scrolling="0" width="100px"
                        height="20px"
                        src="https://ghbtns.com/github-btn.html?user=huxpro&repo=huxpro.github.io&type=star&count=true">
                    </iframe>
                </p>
            </div>
        </div>
    </div>
</footer>

<!-- jQuery -->
<script src="/js/jquery.min.js "></script>

<!-- Bootstrap Core JavaScript -->
<!-- Currently, only navbar scroll-down effect at desktop still depends on this -->
<script src="/js/bootstrap.min.js "></script>

<!-- Custom Theme JavaScript -->
<script src="/js/hux-blog.min.js "></script>

<!-- Simple Jekyll Search -->
<script src="/js/simple-jekyll-search.min.js"></script>

<!-- Service Worker -->

<script src="/js/snackbar.js "></script>
<script src="/js/sw-registration.js "></script>


<!-- async load function -->
<script>
    function async(u, c) {
        var d = document, t = 'script',
            o = d.createElement(t),
            s = d.getElementsByTagName(t)[0];
        o.src = u;
        if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
        s.parentNode.insertBefore(o, s);
    }
</script>

<!--
     Because of the native support for backtick-style fenced code blocks
     right within the Markdown is landed in Github Pages,
     From V1.6, There is no need for Highlight.js,
     so Huxblog drops it officially.

     - https://github.com/blog/2100-github-pages-now-faster-and-simpler-with-jekyll-3-0
     - https://help.github.com/articles/creating-and-highlighting-code-blocks/
     - https://github.com/jneen/rouge/wiki/list-of-supported-languages-and-lexers
-->
<!--
    <script>
        async("http://cdn.bootcss.com/highlight.js/8.6/highlight.min.js", function(){
            hljs.initHighlightingOnLoad();
        })
    </script>
    <link href="http://cdn.bootcss.com/highlight.js/8.6/styles/github.min.css" rel="stylesheet">
-->







<!--fastClick.js -->
<script>
    async("//cdnjs.cloudflare.com/ajax/libs/fastclick/1.0.6/fastclick.min.js", function () {
        var $nav = document.querySelector("nav");
        if ($nav) FastClick.attach($nav);
    })
</script>


<!-- Google Analytics -->

<script>
    // dynamic User by Hux
    var _gaId = 'UA-49627206-1';
    var _gaDomain = 'huangxuan.me';

    // Originial
    (function (i, s, o, g, r, a, m) {
        i['GoogleAnalyticsObject'] = r; i[r] = i[r] || function () {
            (i[r].q = i[r].q || []).push(arguments)
        }, i[r].l = 1 * new Date(); a = s.createElement(o),
            m = s.getElementsByTagName(o)[0]; a.async = 1; a.src = g; m.parentNode.insertBefore(a, m)
    })(window, document, 'script', '//www.google-analytics.com/analytics.js', 'ga');

    ga('create', _gaId, _gaDomain);
    ga('send', 'pageview');
</script>



<!-- Baidu Tongji -->



<!-- Side Catalog -->

<script type="text/javascript">
    function generateCatalog(selector) {

        // interop with multilangual 
        if ('' == 'true') {
            _containerSelector = 'div.post-container.active'
        } else {
            _containerSelector = 'div.post-container'
        }

        // init
        var P = $(_containerSelector), a, n, t, l, i, c;
        a = P.find('h1,h2,h3,h4,h5,h6');

        // clean
        $(selector).html('')

        // appending
        a.each(function () {
            n = $(this).prop('tagName').toLowerCase();
            i = "#" + $(this).prop('id');
            t = $(this).text();
            c = $('<a href="' + i + '" rel="nofollow">' + t + '</a>');
            l = $('<li class="' + n + '_nav"></li>').append(c);
            $(selector).append(l);
        });
        return true;
    }

    generateCatalog(".catalog-body");

    // toggle side catalog
    $(".catalog-toggle").click((function (e) {
        e.preventDefault();
        $('.side-catalog').toggleClass("fold")
    }))

    /*
     * Doc: https://github.com/davist11/jQuery-One-Page-Nav
     * Fork by Hux to support padding
     */
    async("/js/jquery.nav.js", function () {
        $('.catalog-body').onePageNav({
            currentClass: "active",
            changeHash: !1,
            easing: "swing",
            filter: "",
            scrollSpeed: 700,
            scrollOffset: 0,
            scrollThreshold: .2,
            begin: null,
            end: null,
            scrollChange: null,
            padding: 80
        });
    });
</script>



<!-- Multi-Lingual -->


<!-- Simple Jekyll Search -->
<script>
    // https://stackoverflow.com/questions/1912501/unescape-html-entities-in-javascript
    function htmlDecode(input) {
        var e = document.createElement('textarea');
        e.innerHTML = input;
        // handle case of empty input
        return e.childNodes.length === 0 ? "" : e.childNodes[0].nodeValue;
    }

    SimpleJekyllSearch({
        searchInput: document.getElementById('search-input'),
        resultsContainer: document.getElementById('search-results'),
        json: '/search.json',
        searchResultTemplate: '<div class="post-preview item"><a href="{url}"><h2 class="post-title">{title}</h2><h3 class="post-subtitle">{subtitle}</h3><hr></a></div>',
        noResultsText: 'No results',
        limit: 50,
        fuzzy: false,
        // a hack to get escaped subtitle unescaped. for some reason, 
        // post.subtitle w/o escape filter nuke entire search.
        templateMiddleware: function (prop, value, template) {
            if (prop === 'subtitle' || prop === 'title') {
                if (value.indexOf("code")) {
                    return htmlDecode(value);
                } else {
                    return value;
                }
            }
        }
    });

    $(document).ready(function () {
        var $searchPage = $('.search-page');
        var $searchOpen = $('.search-icon');
        var $searchClose = $('.search-icon-close');
        var $searchInput = $('#search-input');
        var $body = $('body');

        $searchOpen.on('click', function (e) {
            e.preventDefault();
            $searchPage.toggleClass('search-active');
            var prevClasses = $body.attr('class') || '';
            setTimeout(function () {
                $body.addClass('no-scroll');
            }, 400)

            if ($searchPage.hasClass('search-active')) {
                $searchClose.on('click', function (e) {
                    e.preventDefault();
                    $searchPage.removeClass('search-active');
                    $body.attr('class', prevClasses);  // from closure 
                });
                $searchInput.focus();
            }
        });
    });
</script>



<!-- Image to hack wechat -->
<img src="/img/icon_wechat.png" width="0" height="0" />
<!-- Migrate from head to bottom, no longer block render and still work -->

</body>

</html>
