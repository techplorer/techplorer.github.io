---
layout:   post
title:   "性能优化常见方法(1)"
subtitle:  ""
date:    2022-08-10 8:00:00
author:   "zhouhaijun"
catalog: false
header-style: text
tags:
 - 性能优化
---



做性能优化也有方法论，如下几个步骤：

#### 建立性能测试基准
当你着手准备做性能优化工作之前，第一件事是建立性能测试的基准，为了后面的一系列优化定一个基准测试值。

#### 找到性能瓶颈点
借助工具，比如vtune或者perf，量化每个阶段的耗时，从而快速找到性能热点。
首先不能依赖自己的直觉或者经验，因为现代软件都是很复杂的，从cpu硬件、编译器、编程语言、各种软件框架，内部的细节实在太复杂，我们自以为是的经验或者直觉往往可能与现实背道而驰。所以我们做性能优化时，一定要有数据支撑，避免在反向优化的道路上越走越远。
这里有几个小工具挺好用的：

- 转换c++语言为汇编语言，可以看到机器具体的指令

  https://godbolt.org/

- 另一个是测试性能的，可以用来对性能优化工作做量化的一种工具

  https://quick-bench.com/#

- 编译器优化的代码，很方便的看c++模板编译后的指令

  https://cppinsights.io/

#### 问题描述和抽象
通过第二步，借助工具，已经可以找到性能热点了，下一步就是对问题进行描述、归纳总结和问题抽象。
举个例子来说:

```c++
std::map<string, int> table;
...
   auto it = table.find(key);
   if (it != table.end()) {
       // find 
   } else {
       // not find
   }
...    
```

上述这段代码，如果发现热点在find，接下来要去思考几个点：

**问题描述：**

通过这段代码，我们了解到，它想要做的就是基于一个string去查找对应的key值。

**问题抽象:**

基于上述问题描述的过程，抽象总结成一句话：基于文本值去查找对应的key。

**搞清楚原理：**

热点既然是在find函数，那进一步的，我们要搞清楚，为什么热点是这里，所以我们要深挖一下背后的工作原理，find的具体工作过程是怎样的？

比如说我们这里的查找过程：传一个string对象，然后在table里通过二分查找，依次与表里的元素做比对，遍历完整个表。

#### 问题拆解：算法、数据结构
有了上述到数据和问题分析，我们再进一步思考：

- 从优化算法的角度考虑

  map的底层实现是一个平衡二叉树，查找平衡二叉树的算法时间开销是O(logN)，那思考一下，有没有更高效一点的算法？可以考虑一下散列表。

- 从数据结构的角度考虑

  使用string作为key，map在查找过程中，会内部构造一个string对象，那么是否可以考虑使用其他的key类型，比如char*。

  无论是map还是unordered_map，本身都是非线形的数据结构，那么这种结构会导致CPU的cache miss，能不能考虑使用线形的结构？

#### 性能测试
最后一步，基于上述的修改，做性能测试，与第一步的基准测试做比较，观察性能优化是否有正向的效果。



做性能优化也有方法论，自顶向下，一层层的拆解开来，跟计算机的递归程序一模一样。
